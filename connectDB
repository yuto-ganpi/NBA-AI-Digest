
from pymongo.mongo_client import MongoClient
from pymongo.server_api import ServerApi
from pprint import pprint
import datetime
import setting
import scrapying
import chatgpt

mongodbatlas_pass = setting.mongodbatlas_pass

uri = f'mongodb+srv://ganpi_atlas:{mongodbatlas_pass}@cluster0.cvknuco.mongodb.net/?retryWrites=true&w=majority'

# Create a new client and connect to the server
client = MongoClient(uri, server_api=ServerApi('1'))

# Send a ping to confirm a successful connection
try:
    client.admin.command('ping')
    print("Pinged your deployment. You successfully connected to MongoDB!")
except Exception as e:
    print(e)
    
db = client['nbaaimedia']
rapidapi = db['rapidapi']

def make_basic_info():
    basic_info = scrapying.rapidapi()

    for data in basic_info:
        rapidapi.insert_one(data)
        
def insert_content():
    # データを取り出してcontentを作成し、contentカラムに追加
    for data in rapidapi.find({"source": "nba"}):
        url = data["url"]
        content = scrapying.make_content(url)
        rapidapi.update_one({"url": url}, {"$set": {"content": content}})
    return

# "source"がnbaでないデータのカラム"content"を削除
# query = {"source": {"$ne": "nba"}}
# update = {"$unset": {"content": 1}}
# rapidapi.update_many(query, update)

for data in rapidapi.find({"source": "nba"}):
    content = data["content"]
    summary = chatgpt.make_summary(content)
    rapidapi.update_one({"_id": data["_id"]}, {"$set": {"summary": summary}})
    